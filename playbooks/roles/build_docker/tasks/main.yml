---
- name: Copy Dockerfile with parameters (port number defines by user) from jinja template
  template :
    src: Dockerfile.j2
    dest: /home/{{ DOCKER_USER }}/Dockerfile


- name: Copy daemon.json from jinja template
  become: true
  template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json


- name: Restart docker service
  become: true
  systemd:
    state: restarted
    daemon_reload: yes
    name: docker


- name: Login to the Nexus docker repository
  become_user: docker
  become: true
  docker_login:
    registry: http://{{ NEXUS_SERVER_IP }}:{{ NEXUS_DOCKER_PORT }}
    username: "{{ MAVEN_LOGIN }}"
    password: "{{ MAVEN_PASSWORD }}"
    reauthorize: yes


- name: Build Spring boot image from repository using build variables
  become_user: docker
  become: true
  docker_image:
    name: spring-boot-smoke-test-web-ui
    repository: "{{ NEXUS_SERVER_IP }}:{{ NEXUS_DOCKER_PORT }}/javapp"
    tag: "{{ BUILD_NUMBER }}"
    build:
      path: /home/{{ DOCKER_USER }}/
    source: build
